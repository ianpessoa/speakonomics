<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Simulador — Bolha de Ativos</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{font-family:Inter,Arial,sans-serif;background:#f5f7fa;margin:0;padding:20px;color:#111827}
  .wrap{max-width:1100px;margin:0 auto}
  h1{margin-bottom:6px}
  p.small{color:#6b7280;margin-top:0;margin-bottom:14px}
  .controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
  .ctrl{background:#fff;padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  label{display:block;font-weight:700;margin-bottom:6px;font-size:0.95rem}
  .value{font-weight:800;color:#2563eb}
  input[type=range]{width:220px}
  #charts{display:flex;gap:12px;flex-wrap:wrap}
  .chart-card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);flex:1 1 540px;min-width:320px}
  canvas{width:100%!important;height:320px!important}
  .info{display:flex;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap}
  .badge{background:#eef6ff;padding:8px 12px;border-radius:10px;font-weight:700;color:#1f6feb}
  .status{padding:8px 12px;border-radius:10px}
  .status.ok{background:#ecfdf5;color:#059669}
  .status.warn{background:#fff7ed;color:#b45309}
  .status.bad{background:#fef2f2;color:#b91c1c}
  footer{margin-top:14px;color:#8b95a6;font-size:0.85rem}
</style>
</head>
<body>
<div class="wrap">
  <h1>Simulador — Bolha de Ativos</h1>
  <p class="small">Ajuste a <strong>liquidez</strong> e o <strong>choque de expectativas</strong> e observe a formação e o estouro de bolhas. O modelo mostra retroalimentação preço–expectativa e comportamento de manada.</p>

  <div class="controls">
    <div class="ctrl">
      <label>Liquidez</label>
      <input id="liquidity" type="range" min="0.5" max="2.5" step="0.05" value="1.0">
      <div>Valor: <span id="liquidityVal" class="value">1.00</span></div>
    </div>

    <div class="ctrl">
      <label>Expectativas (choque exógeno)</label>
      <input id="expSlider" type="range" min="0.6" max="2.5" step="0.01" value="1.10">
      <div>Valor: <span id="expVal" class="value">1.10</span></div>
      <div style="font-size:12px;color:#7b8794;margin-top:6px">Mudar aqui aplica um choque temporário.</div>
    </div>

    <div class="ctrl">
      <label>Força do choque inicial</label>
      <input id="shockK" type="range" min="0" max="0.06" step="0.002" value="0.02">
      <div>Coeficiente k: <span id="shockKVal" class="value">0.02</span></div>
    </div>

    <button id="resetBtn" style="margin-left:auto;padding:8px 12px;border-radius:8px;border:0;background:#1f6feb;color:#fff;font-weight:700;cursor:pointer">Reset</button>
  </div>

  <div id="charts">
    <div class="chart-card">
      <canvas id="priceChart"></canvas>
      <div class="info">
        <div class="badge">Preço: <span id="priceBadge">-</span></div>
        <div class="badge">Fundamental: <span id="fundBadge">-</span></div>
        <div id="stateStatus" class="status warn">Iniciando</div>
      </div>
    </div>

    <div class="chart-card">
      <canvas id="expChart"></canvas>
      <div class="info">
        <div class="badge">Expectativas: <span id="expBadge">-</span></div>
      </div>
    </div>
  </div>

  <footer>Modelo simplificado para fins didáticos: demonstra retroalimentação entre preços e expectativas, formação e estouro de bolhas.</footer>
</div>

<script>
const H = 200;
let t=0, price=100, fundamental=85, baseFundamental=85, expectations=1.1, liquidity=1.0;
let inBubble=false, busted=false, userLocked=false, lockTimer=0, bubbleCap=NaN;

const liquidityEl=document.getElementById('liquidity');
const liquidityVal=document.getElementById('liquidityVal');
const expSlider=document.getElementById('expSlider');
const expVal=document.getElementById('expVal');
const shockK=document.getElementById('shockK');
const shockKVal=document.getElementById('shockKVal');
const priceBadge=document.getElementById('priceBadge');
const fundBadge=document.getElementById('fundBadge');
const expBadge=document.getElementById('expBadge');
const stateStatus=document.getElementById('stateStatus');
const resetBtn=document.getElementById('resetBtn');

let times=[0], prices=[price], fundamentals=[fundamental], exps=[expectations];

const randn=s=>Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random())*s;

const ctx1=document.getElementById('priceChart').getContext('2d');
const ctx2=document.getElementById('expChart').getContext('2d');
const priceChart=new Chart(ctx1,{type:'line',data:{labels:times,datasets:[
  {label:'Preço',data:prices,borderColor:'#2563eb',tension:0.15,borderWidth:2,fill:false,pointRadius:0},
  {label:'Valor Fundamental',data:fundamentals,borderColor:'#9aa6b8',borderDash:[6,4],tension:0.1,borderWidth:1,fill:false,pointRadius:0}
]},options:{animation:false,responsive:true,maintainAspectRatio:false,scales:{x:{title:{display:true,text:'Tempo'}},y:{title:{display:true,text:'Preço'}}}}});
const expChart=new Chart(ctx2,{type:'line',data:{labels:times,datasets:[
  {label:'Expectativas',data:exps,borderColor:'#16a34a',tension:0.2,borderWidth:2,fill:false,pointRadius:0}
]},options:{animation:false,responsive:true,maintainAspectRatio:false,scales:{x:{title:{display:true,text:'Tempo'}},y:{title:{display:true,text:'Expectativas'}}},plugins:{legend:{display:false}}}});

const baseNoiseFund=0.2, meanRevFund=0.02, expNoise=0.01;
const expMeanRev=0.01, specK=0.5, bubbleTrigger=1.3, recoverySpeed=0.01;

function step(){
  liquidity=parseFloat(liquidityEl.value);
  liquidityVal.textContent=liquidity.toFixed(2);

  fundamental += -meanRevFund*(fundamental-baseFundamental)+randn(baseNoiseFund*0.5);

  if(!userLocked){
    expectations += -expMeanRev*(expectations-1)+randn(expNoise)*0.005;
  } else if(--lockTimer<=0){ userLocked=false; }

  if(!busted){
    let growth=specK*(expectations-1)*0.01*liquidity + 0.02*(fundamental-price)/price + randn(0.001)*liquidity;

    // Início da bolha: expectativa alta dispara feedback
    if(expectations > bubbleTrigger && !inBubble){
      inBubble=true;
      bubbleCap=fundamental*(2.5+Math.random()*2.0); // teto aleatório
    }

    if(inBubble){
      // feedback acelerado
      growth += 0.02*(expectations-1)*liquidity;
      expectations += 0.01*(price/fundamental - 1); // preço alto alimenta expectativas
      if(price>=bubbleCap){
        busted=true; inBubble=false;
        price=Math.max(1,fundamental*0.6*(0.7+Math.random()*0.3)); // queda forte
        expectations=Math.max(0.5,expectations*0.5);
      } else {
        price*=(1+growth);
      }
    } else price*=(1+growth);
  } else {
    // fase pós-estouro
    price+=(fundamental-price)*recoverySpeed;
    expectations+=(1-expectations)*recoverySpeed*0.5;
    if(Math.abs(price-fundamental)<2 && Math.abs(expectations-1)<0.05){busted=false;}
  }

  expectations=Math.min(3,Math.max(0.4,expectations));
  if(!isFinite(price)||price<=0)price=1;

  t++;
  times.push(t); prices.push(price); fundamentals.push(fundamental); exps.push(expectations);
  if(times.length>H){times.shift();prices.shift();fundamentals.shift();exps.shift();}

  expSlider.value=expectations; expVal.textContent=expectations.toFixed(2);
  priceChart.data.labels=times; priceChart.data.datasets[0].data=prices; priceChart.data.datasets[1].data=fundamentals; priceChart.update('none');
  expChart.data.labels=times; expChart.data.datasets[0].data=exps; expChart.update('none');

  priceBadge.textContent=price.toFixed(2);
  fundBadge.textContent=fundamental.toFixed(2);
  expBadge.textContent=expectations.toFixed(3);

  if(busted){stateStatus.textContent='Bolha estourou — correção em curso';stateStatus.className='status bad';}
  else if(inBubble){stateStatus.textContent='Bolha em formação';stateStatus.className='status warn';}
  else{stateStatus.textContent='Mercado em equilíbrio';stateStatus.className='status ok';}

  requestAnimationFrame(step);
}

expSlider.addEventListener('input',e=>{
  const newV=Number(e.target.value);
  const k=Number(shockK.value);
  const delta=newV-expectations;
  expectations=newV;
  userLocked=true; lockTimer=180;
  expVal.textContent=expectations.toFixed(2);
  price*=(1+k*delta*liquidity);
});
shockK.addEventListener('input',()=>shockKVal.textContent=Number(shockK.value).toFixed(3));
liquidityEl.addEventListener('input',()=>liquidityVal.textContent=liquidityEl.value);
resetBtn.addEventListener('click',()=>{
  t=0;price=100;fundamental=baseFundamental;expectations=1.1;liquidity=1.0;inBubble=busted=false;
  times=[0];prices=[price];fundamentals=[fundamental];exps=[expectations];
  liquidityEl.value=liquidity;expSlider.value=expectations;shockK.value=0.02;
});

requestAnimationFrame(step);
</script>
</body>
</html>
