<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Modelo Clássico: Gravitação de Preços e Lucros</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Estilo elegante com fundo animado -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    :root {
      --primary: #38bdf8;
      --secondary: #16a34a;
      --accent: #22d3ee;
      --text: #f1f5f9;
      --subtext: #94a3b8;
      --card: rgba(17, 24, 39, 0.75);
      --radius: 14px;
      --shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      overflow-x: hidden;
      background: linear-gradient(-45deg, #0f172a, #1e293b, #0c4a6e, #0f766e);
      background-size: 400% 400%;
      animation: gradientMove 18s ease infinite;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      background: var(--card);
      padding: 32px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      width: 900px;
      max-width: 95%;
    }

    h2 {
      text-align: center;
      font-size: 1.8rem;
      font-weight: 600;
      margin-top: 0;
      color: var(--primary);
    }

    .control-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      gap: 12px;
    }

    label {
      font-weight: 600;
      flex: 1;
      font-size: 0.95rem;
    }

    input[type="number"], input[type="range"] {
      flex: 1;
    }

    input[type="number"] {
      padding: 6px;
      border-radius: var(--radius);
      border: 1px solid #334155;
      background: #1e293b;
      color: var(--text);
      width: 100%;
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--primary);
    }

    #speedDisplay, #marketProfitRateDisplay, #avgProfitRateDisplay, #demandDisplay {
      font-weight: 600;
      color: var(--accent);
    }

    p {
      margin: 6px 0;
      font-size: 0.95rem;
      text-align: center;
    }

    .small {
      font-size: 0.8rem;
      color: var(--subtext);
      margin-bottom: 12px;
      text-align: center;
    }

    canvas {
      margin-top: 20px;
      border-radius: var(--radius);
      background: #0f172a;
      box-shadow: inset 0 0 10px rgba(255,255,255,0.05);
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Modelo Clássico: Gravitação de Preços e Lucros</h2>

  <div class="control-group">
    <label>Custo de Produção (constante):</label>
    <input type="number" id="cost" value="10" step="0.1">
  </div>

  <div class="control-group">
    <label>Taxa Normal/Equalizada de Lucro (%):</label>
    <input type="range" id="avgProfitRate" min="1" max="50" value="20">
    <span id="avgProfitRateDisplay">20%</span>
  </div>

  <div class="control-group">
    <label>Demanda (quantidade):</label>
    <input type="range" id="demand" min="10" max="500" value="200">
    <span id="demandDisplay">200</span>
  </div>

  <div class="control-group">
    <label>Taxa de Lucro de Mercado (%):</label>
    <input type="range" id="marketProfitRate" min="1" max="80" value="20">
    <span id="marketProfitRateDisplay">20%</span>
  </div>

  <div class="control-group">
    <label>Oferta (quantidade):</label>
    <input type="number" id="supply" value="200" readonly>
  </div>

  <div class="control-group">
    <label>Velocidade do Ajuste:</label>
    <input type="range" id="speedControl" min="0.5" max="2" value="0.5" step="0.1">
    <span id="speedDisplay">Lento</span>
  </div>

  <p><b>Preço Natural:</b> R$ <span id="naturalPrice">0</span></p>
  <p><b>Preço de Mercado:</b> R$ <span id="marketPrice">0</span></p>
  <p class="small">Choque ao mover demanda/lucro → depois gravitação suave até o equilíbrio.</p>

  <canvas id="chart" width="900" height="360"></canvas>
</div>

<script>
function naturalPrice(cost, avgProfitRate) { return cost * (1 + avgProfitRate); }
function marketPrice(cost, marketProfitRate) { return cost * (1 + marketProfitRate); }

let cost = 10, avgProfitRate = 0.20, demand = 200, marketProfitRate = 0.20, supply = 200;
let lastUserMarketProfitRate = marketProfitRate;
let lastUserDemand = demand;

const IMMEDIATE_LIMIT = 0.9;
const BASE_SUPPLY_SPEED = 0.05;
const BASE_K_SUPPLY_DEVIATION = 0.02;
const BASE_K_DELTA_SUPPLY = 0.5;
const BASE_K_PULL_TO_NORMAL = 0.01;

let speedFactor = 0.5;

function updateSpeedLabel(val) {
  if (val < 0.7) return "Muito lento";
  if (val < 1.0) return "Lento";
  if (val < 1.3) return "Normal";
  if (val < 1.6) return "Rápido";
  return "Turbo";
}

const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: Array.from({ length: 501 }, (_, i) => i),
    datasets: [
      {
        label: "Demanda",
        data: [{ x: demand, y: 0 }, { x: demand, y: 0 }],
        borderColor: '#22d3ee',
        borderDash: [6, 4],
        borderWidth: 2,
        pointRadius: 0
      },
      {
        label: "Preço Natural",
        data: Array(501).fill(0),
        borderColor: '#94a3b8',
        borderWidth: 2,
        pointRadius: 0
      },
      {
        label: "Preço de Mercado",
        data: [{ x: supply, y: marketPrice(cost, marketProfitRate) }],
        borderColor: '#38bdf8',
        backgroundColor: '#38bdf8',
        pointRadius: 7,
        pointHoverRadius: 9,
        showLine: false
      },
      {
        label: "Oferta",
        data: [{ x: supply, y: 0 }, { x: supply, y: 0 }],
        borderColor: '#16a34a',
        borderDash: [6, 4],
        borderWidth: 2,
        pointRadius: 0
      }
    ]
  },
  options: {
    animation: false,
    scales: {
      x: { type: 'linear', min: 0, max: 500, title: { display: true, text: 'Quantidade' } },
      y: { min: 0, title: { display: true, text: 'Preço' } }
    },
    plugins: {
      legend: { labels: { color: '#e2e8f0' } }
    }
  }
});

function syncDisplays() {
  document.getElementById('avgProfitRateDisplay').textContent = (document.getElementById('avgProfitRate').value) + '%';
  document.getElementById('demandDisplay').textContent = demand;
  document.getElementById('marketProfitRateDisplay').textContent = (marketProfitRate*100).toFixed(2) + '%';
  document.getElementById('speedDisplay').textContent = updateSpeedLabel(speedFactor);
}

function update() {
  cost = parseFloat(document.getElementById('cost').value);
  avgProfitRate = parseFloat(document.getElementById('avgProfitRate').value)/100;
  let newDemand = parseFloat(document.getElementById('demand').value);
  const userMarketProfitRate = parseFloat(document.getElementById('marketProfitRate').value)/100;

  if (newDemand !== lastUserDemand) {
    const baseDemandShock = 0.05;
    const shock = baseDemandShock * Math.max(0.05, speedFactor);
    marketProfitRate += (newDemand > lastUserDemand ? shock : -shock);
    lastUserDemand = newDemand;
  }
  demand = newDemand;

  const userChanged = Math.abs(userMarketProfitRate - lastUserMarketProfitRate) > 1e-6;
  if (userChanged) {
    let profitDiff = (userMarketProfitRate - avgProfitRate) / avgProfitRate;
    profitDiff = Math.max(-IMMEDIATE_LIMIT, Math.min(IMMEDIATE_LIMIT, profitDiff));
    supply = demand * (1 - profitDiff);
    supply = Math.max(1, supply);
    lastUserMarketProfitRate = userMarketProfitRate;
    marketProfitRate = userMarketProfitRate;
  }

  const GRADUAL_SUPPLY_SPEED = BASE_SUPPLY_SPEED * speedFactor;
  const K_SUPPLY_DEVIATION = BASE_K_SUPPLY_DEVIATION * Math.pow(speedFactor, 2);
  const K_DELTA_SUPPLY = BASE_K_DELTA_SUPPLY * Math.pow(speedFactor, 2);
  const K_PULL_TO_NORMAL = BASE_K_PULL_TO_NORMAL * Math.pow(speedFactor, 2);

  const prevSupply = supply;
  supply += GRADUAL_SUPPLY_SPEED * (demand - supply);
  supply = Math.max(1, supply);

  const delta = supply - prevSupply;
  const deltaNorm = delta / Math.max(1, demand);
  const diff = (supply - demand) / Math.max(1, demand);

  let force = -K_SUPPLY_DEVIATION * diff;
  force += -K_DELTA_SUPPLY * deltaNorm;
  force += K_PULL_TO_NORMAL * (avgProfitRate - marketProfitRate);

  marketProfitRate += force;

  const damping = 0.98 + (1 - speedFactor) * 0.015;
  marketProfitRate = marketProfitRate * damping + (1 - damping) * avgProfitRate;

  marketProfitRate = Math.max(0.0001, marketProfitRate);
  marketProfitRate = Math.min(2.0, marketProfitRate);

  document.getElementById('marketProfitRate').value = (marketProfitRate*100).toFixed(0);
  document.getElementById('supply').value = supply.toFixed(2);

  const nP = naturalPrice(cost, avgProfitRate);
  const mP = marketPrice(cost, marketProfitRate);

  document.getElementById('naturalPrice').textContent = nP.toFixed(2);
  document.getElementById('marketPrice').textContent = mP.toFixed(2);
  syncDisplays();

  chart.data.datasets[0].data = [{ x:demand, y:0 }, { x:demand, y:mP*3 }];
  chart.data.datasets[1].data = Array(501).fill(nP);
  chart.data.datasets[2].data = [{ x: supply, y: mP }];
  chart.data.datasets[3].data = [{ x:supply, y:0 }, { x:supply, y:mP*3 }];

  chart.options.scales.y.min = 0;
  chart.options.scales.y.max = Math.max(nP, mP) * 1.2;

  chart.update();
  requestAnimationFrame(update);
}

requestAnimationFrame(update);

document.getElementById('speedControl').addEventListener('input', e=>{
  speedFactor = parseFloat(e.target.value);
  syncDisplays();
});
document.getElementById('avgProfitRate').addEventListener('input', syncDisplays);
document.getElementById('demand').addEventListener('input', syncDisplays);
document.getElementById('marketProfitRate').addEventListener('input', syncDisplays);
</script>

</body>
</html>
