<!-- Styled minimalist version of the price gravitation model.  
Paste your previous functional script inside the <script> area below where indicated.
I kept placeholders so you can easily locate it. -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gravitação de Preços — Modelo Clássico</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --bg: #f8f9fb;
    --card: #ffffff;
    --text: #1b1e23;
    --accent: #3a6ff7;
    --subtle: #a0a7b4;
    --radius: 14px;
    --shadow: 0 8px 16px rgba(0,0,0,0.08);
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    padding: 0;
    font-family: "Inter", sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    text-align: center;
    padding: 24px;
  }
  h1 {
    margin: 0;
    font-size: 1.9rem;
    font-weight: 600;
  }
  .container {
    max-width: 900px;
    width: 100%;
    margin: 0 auto;
    padding: 20px;
  }
  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
  }
  label {
    font-size: 0.9rem;
    color: var(--subtle);
  }
  input, select {
    border: 1px solid #d1d6e0;
    border-radius: var(--radius);
    padding: 8px 12px;
    font-size: 0.9rem;
    background: #fff;
  }
  button {
    padding: 10px 16px;
    border-radius: var(--radius);
    border: none;
    background: var(--accent);
    color: #fff;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all .2s ease;
  }
  button:hover { opacity: .9; }
  .panel {
    display: flex;
    justify-content: space-between;
    margin-top: 16px;
    font-size: 0.9rem;
    color: var(--subtle);
  }
  canvas { margin-top: 20px; }
</style>
</head>
<body>
<header>
  <h1>Gravitação de Preços — Modelo Clássico</h1>
</header>
<div class="container">
  <div class="card">
    <div class="controls">
      <div>
        <label>Taxa Equalizada:</label><br>
        <input type="number" id="targetRate" step="0.01" value="0.15">
      </div>
      <div>
        <label>Velocidade de Ajuste:</label><br>
        <select id="speed">
          <option value="1">Rápido</option>
          <option value="0.5">Médio</option>
          <option value="0.2">Lento</option>
          <option value="0.05">Muito Lento</option>
        </select>
      </div>
      <div style="display:flex; gap:10px; align-items:flex-end;">
        <button id="shockBtn">Aplicar Choque</button>
        <button id="resetBtn" style="background:#e64e4e;">Resetar</button>
      </div>
    </div>
    <div class="panel">
      <span>Lucro Atual: <strong id="profitDisplay">-</strong></span>
      <span>Oferta Atual: <strong id="supplyDisplay">-</strong></span>
    </div>
  </div>

  <div class="card">
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
function naturalPrice(cost, avgProfitRate) { return cost * (1 + avgProfitRate); }
function marketPrice(cost, marketProfitRate) { return cost * (1 + marketProfitRate); }

let cost = 10, avgProfitRate = 0.20, demand = 200, marketProfitRate = 0.20, supply = 200;
let lastUserMarketProfitRate = marketProfitRate;
let lastUserDemand = demand;

// PARÂMETROS BASE
const IMMEDIATE_LIMIT = 0.9;
const BASE_SUPPLY_SPEED = 0.05;
const BASE_K_SUPPLY_DEVIATION = 0.02;
const BASE_K_DELTA_SUPPLY = 0.5;
const BASE_K_PULL_TO_NORMAL = 0.01;

// NOVO
let speedFactor = 0.5;

function updateSpeedLabel(val) {
  if (val < 0.3) return "Muito lento";
  if (val < 0.7) return "Lento";
  if (val < 1.2) return "Normal";
  if (val < 1.6) return "Rápido";
  return "Turbo";
}

const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: Array.from({ length: 501 }, (_, i) => i),
    datasets: [
      { label: "Demanda", data: [{ x:demand, y:0 }, { x:demand, y:0 }], borderWidth: 2, borderDash: [6,4], pointRadius: 0 },
      { label: "Preço Natural", data: Array(501).fill(0), borderWidth: 2, pointRadius: 0 },
      { label: "Preço de Mercado", data: Array(501).fill(null), borderWidth: 0, pointRadius: 8 },
      { label: "Oferta", data: [{ x:supply, y:0 }, { x:supply, y:0 }], borderWidth: 2, borderDash: [6,4], pointRadius: 0 }
    ]
  },
  options: {
    animation: false,
    scales: { x:{ type:'linear', min:0, max:500 }, y:{ min:0 } }
  }
});

function syncDisplays() {
  document.getElementById('avgProfitRateDisplay').textContent = (document.getElementById('avgProfitRate').value) + '%';
  document.getElementById('demandDisplay').textContent = demand;
  document.getElementById('marketProfitRateDisplay').textContent = (marketProfitRate*100).toFixed(2) + '%';
  document.getElementById('speedDisplay').textContent = updateSpeedLabel(speedFactor);
}

function update() {
  cost = parseFloat(document.getElementById('cost').value);
  avgProfitRate = parseFloat(document.getElementById('avgProfitRate').value)/100;
  let newDemand = parseFloat(document.getElementById('demand').value);
  const userMarketProfitRate = parseFloat(document.getElementById('marketProfitRate').value)/100;

  // *** ajuste do choque de demanda escalado pelo speedFactor ***
  if (newDemand !== lastUserDemand) {
    // magnitude do choque proporcional à velocidade: em modo lento, choque é menor
    const baseDemandShock = 0.05;
    const shock = baseDemandShock * Math.max(0.05, speedFactor); // nunca zero
    marketProfitRate += (newDemand > lastUserDemand ? shock : -shock);
    lastUserDemand = newDemand;
  }
  demand = newDemand;

  // choque lucro (manipulação direta do slider) — permanece imediato
  const userChanged = Math.abs(userMarketProfitRate - lastUserMarketProfitRate) > 1e-6;
  if (userChanged) {
    let profitDiff = (userMarketProfitRate - avgProfitRate) / avgProfitRate;
    profitDiff = Math.max(-IMMEDIATE_LIMIT, Math.min(IMMEDIATE_LIMIT, profitDiff));
    supply = demand * (1 - profitDiff);
    supply = Math.max(1, supply);
    lastUserMarketProfitRate = userMarketProfitRate;
    marketProfitRate = userMarketProfitRate;
  }

  // /// GRAVITAÇÃO ESCALADA PELA VELOCIDADE ///
  const GRADUAL_SUPPLY_SPEED = BASE_SUPPLY_SPEED * speedFactor;
  const K_SUPPLY_DEVIATION = BASE_K_SUPPLY_DEVIATION * speedFactor;
  const K_DELTA_SUPPLY = BASE_K_DELTA_SUPPLY * speedFactor;
  const K_PULL_TO_NORMAL = BASE_K_PULL_TO_NORMAL * speedFactor;

  const prevSupply = supply;
  supply += GRADUAL_SUPPLY_SPEED * (demand - supply);
  supply = Math.max(1, supply);

  const delta = supply - prevSupply;
  const deltaNorm = delta / Math.max(1, demand);
  const diff = (supply - demand) / Math.max(1, demand);

  let force = -K_SUPPLY_DEVIATION * diff;
  force += -K_DELTA_SUPPLY * deltaNorm;
  force += K_PULL_TO_NORMAL * (avgProfitRate - marketProfitRate);

  marketProfitRate += force;

  // Limitações de segurança: evitar lucro absurdo / negativo
  marketProfitRate = Math.max(0.0001, marketProfitRate);
  marketProfitRate = Math.min(2.0, marketProfitRate); // teto 200% para segurança

  document.getElementById('marketProfitRate').value = (marketProfitRate*100).toFixed(0);
  document.getElementById('supply').value = supply.toFixed(2);

  const nP = naturalPrice(cost, avgProfitRate);
  const mP = marketPrice(cost, marketProfitRate);

  document.getElementById('naturalPrice').textContent = nP.toFixed(2);
  document.getElementById('marketPrice').textContent = mP.toFixed(2);
  syncDisplays();

  chart.data.datasets[0].data = [{ x:demand, y:0 }, { x:demand, y:mP*3 }];
  chart.data.datasets[1].data = Array(501).fill(nP);
  chart.data.datasets[2].data = Array(501).fill(null);
  chart.data.datasets[2].data[Math.round(Math.min(500, Math.max(0, supply)))] = mP;
  chart.data.datasets[3].data = [{ x:supply, y:0 }, { x:supply, y:mP*3 }];

  chart.update();
  requestAnimationFrame(update);
}

requestAnimationFrame(update);

document.getElementById('speedControl').addEventListener('input', e=>{
  speedFactor = parseFloat(e.target.value);
  syncDisplays();
});
document.getElementById('avgProfitRate').addEventListener('input', syncDisplays);
document.getElementById('demand').addEventListener('input', syncDisplays);
document.getElementById('marketProfitRate').addEventListener('input', syncDisplays);
</script>
</body>
</html>
