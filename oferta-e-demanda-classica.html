<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Modelo Clássico: Gravitação de Preços e Lucros</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: radial-gradient(circle at top left, #0f172a, #020617);
      margin: 0;
      padding: 20px;
      color: #e2e8f0;
      overflow-x: hidden;
    }

    #particles {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
    }

    .wrap {
      position: relative;
      z-index: 1;
      max-width: 900px; /* Ajustado para o container original */
      margin: 0 auto;
    }

    h2 {
      margin-bottom: 12px;
      color: #38bdf8;
      font-size: 2rem;
      text-align: center;
    }

    .container {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(8px);
      padding: 32px;
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }

    .control-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
      gap: 12px;
    }

    label {
      font-weight: 600;
      flex: 1;
      font-size: 0.95rem;
      color: #e0f2fe;
    }

    input[type="number"], input[type="range"] {
      flex: 1;
    }

    input[type="number"] {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #334155;
      background: #1e293b;
      color: #e2e8f0;
      width: 100%;
      box-sizing: border-box;
    }

    input[type="range"] {
      width: 100%;
      accent-color: #38bdf8;
    }

    #speedDisplay, #marketProfitRateDisplay, #avgProfitRateDisplay, #demandDisplay {
      font-weight: 700;
      color: #38bdf8;
      min-width: 50px; /* Para manter o alinhamento */
      text-align: right;
    }

    p {
      margin: 6px 0;
      font-size: 0.95rem;
      text-align: center;
    }

    p b {
      color: #38bdf8;
    }

    .small {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-bottom: 12px;
      text-align: center;
    }

    canvas {
      margin-top: 20px;
      border-radius: 15px;
      background: #0f172a;
      box-shadow: inset 0 0 10px rgba(255,255,255,0.05);
    }

    /* Estilo do botão Voltar */
    a.back {
      display: inline-block;
      margin-bottom: 12px;
      text-decoration: none;
      color: #94a3b8;
      transition: color 0.2s;
      font-weight: 600;
    }

    a.back:hover {
      color: #38bdf8;
    }
  </style>
</head>
<body>

<canvas id="particles"></canvas>
<div class="wrap">
  <a href="index.html" class="back">← Voltar ao início</a>

  <div class="container">
    <h2>Modelo Clássico: Gravitação de Preços e Lucros</h2>

    <div class="control-group">
      <label>Custo de Produção (constante):</label>
      <input type="number" id="cost" value="10" step="0.1">
    </div>

    <div class="control-group">
      <label>Taxa Normal/Equalizada de Lucro (%):</label>
      <input type="range" id="avgProfitRate" min="1" max="50" value="20">
      <span id="avgProfitRateDisplay">20%</span>
    </div>

    <div class="control-group">
      <label>Demanda (quantidade):</label>
      <input type="range" id="demand" min="10" max="500" value="200">
      <span id="demandDisplay">200</span>
    </div>

    <div class="control-group">
      <label>Taxa de Lucro de Mercado (%):</label>
      <input type="range" id="marketProfitRate" min="1" max="80" value="20">
      <span id="marketProfitRateDisplay">20%</span>
    </div>

    <div class="control-group">
      <label>Oferta (quantidade):</label>
      <input type="number" id="supply" value="200" readonly>
    </div>

    <div class="control-group">
      <label>Velocidade do Ajuste:</label>
      <input type="range" id="speedControl" min="0.5" max="2" value="0.5" step="0.1">
      <span id="speedDisplay">Lento</span>
    </div>

    <p><b>Preço Natural:</b> R$ <span id="naturalPrice">0</span></p>
    <p><b>Preço de Mercado:</b> R$ <span id="marketPrice">0</span></p>
    <p class="small">Choque ao mover demanda/lucro → depois gravitação suave até o equilíbrio.</p>

    <canvas id="chart" width="900" height="360"></canvas>
  </div>
</div>

<script>
function naturalPrice(cost, avgProfitRate) { return cost * (1 + avgProfitRate); }
function marketPrice(cost, marketProfitRate) { return cost * (1 + marketProfitRate); }

let cost = 10, avgProfitRate = 0.20, demand = 200, marketProfitRate = 0.20, supply = 200;
let lastUserMarketProfitRate = marketProfitRate;
let lastUserDemand = demand;

const IMMEDIATE_LIMIT = 0.9;
const BASE_SUPPLY_SPEED = 0.05;
const BASE_K_SUPPLY_DEVIATION = 0.02;
const BASE_K_DELTA_SUPPLY = 0.5;
const BASE_K_PULL_TO_NORMAL = 0.01;

let speedFactor = 0.5;

function updateSpeedLabel(val) {
  if (val < 0.7) return "Muito lento";
  if (val < 1.0) return "Lento";
  if (val < 1.3) return "Normal";
  if (val < 1.6) return "Rápido";
  return "Turbo";
}

const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: Array.from({ length: 501 }, (_, i) => i),
    datasets: [
      {
        label: "Demanda",
        data: [{ x: demand, y: 0 }, { x: demand, y: 0 }],
        borderColor: '#22d3ee', /* Mantido o ciano para Demanda */
        borderDash: [6, 4],
        borderWidth: 2,
        pointRadius: 0
      },
      {
        label: "Preço Natural",
        data: Array(501).fill(0),
        borderColor: '#94a3b8', /* Mantido o cinza para Preço Natural */
        borderWidth: 2,
        pointRadius: 0
      },
      {
        label: "Preço de Mercado",
        data: [{ x: supply, y: marketPrice(cost, marketProfitRate) }],
        borderColor: '#38bdf8', /* Mantido o azul para Preço de Mercado */
        backgroundColor: '#38bdf8',
        pointRadius: 7,
        pointHoverRadius: 9,
        showLine: false
      },
      {
        label: "Oferta",
        data: [{ x: supply, y: 0 }, { x: supply, y: 0 }],
        borderColor: '#16a34a', /* Mantido o verde para Oferta */
        borderDash: [6, 4],
        borderWidth: 2,
        pointRadius: 0
      }
    ]
  },
  options: {
    animation: false,
    scales: {
      x: { 
        type: 'linear', 
        min: 0, 
        max: 500, 
        title: { display: true, text: 'Quantidade', color: '#e2e8f0' },
        ticks: { color: '#94a3b8' },
        grid: { color: 'rgba(255,255,255,0.1)' }
      },
      y: { 
        min: 0, 
        title: { display: true, text: 'Preço', color: '#e2e8f0' },
        ticks: { color: '#94a3b8' },
        grid: { color: 'rgba(255,255,255,0.1)' }
      }
    },
    plugins: {
      legend: { labels: { color: '#e2e8f0' } }
    }
  }
});

function syncDisplays() {
  document.getElementById('avgProfitRateDisplay').textContent = (document.getElementById('avgProfitRate').value) + '%';
  document.getElementById('demandDisplay').textContent = demand;
  document.getElementById('marketProfitRateDisplay').textContent = (marketProfitRate*100).toFixed(2) + '%';
  document.getElementById('speedDisplay').textContent = updateSpeedLabel(speedFactor);
}

function update() {
  cost = parseFloat(document.getElementById('cost').value);
  avgProfitRate = parseFloat(document.getElementById('avgProfitRate').value)/100;
  let newDemand = parseFloat(document.getElementById('demand').value);
  const userMarketProfitRate = parseFloat(document.getElementById('marketProfitRate').value)/100;

  if (newDemand !== lastUserDemand) {
    const baseDemandShock = 0.05;
    const shock = baseDemandShock * Math.max(0.05, speedFactor);
    marketProfitRate += (newDemand > lastUserDemand ? shock : -shock);
    lastUserDemand = newDemand;
  }
  demand = newDemand;

  const userChanged = Math.abs(userMarketProfitRate - lastUserMarketProfitRate) > 1e-6;
  if (userChanged) {
    let profitDiff = (userMarketProfitRate - avgProfitRate) / avgProfitRate;
    profitDiff = Math.max(-IMMEDIATE_LIMIT, Math.min(IMMEDIATE_LIMIT, profitDiff));
    supply = demand * (1 - profitDiff);
    supply = Math.max(1, supply);
    lastUserMarketProfitRate = userMarketProfitRate;
    marketProfitRate = userMarketProfitRate;
  }

  const GRADUAL_SUPPLY_SPEED = BASE_SUPPLY_SPEED * speedFactor;
  const K_SUPPLY_DEVIATION = BASE_K_SUPPLY_DEVIATION * Math.pow(speedFactor, 2);
  const K_DELTA_SUPPLY = BASE_K_DELTA_SUPPLY * Math.pow(speedFactor, 2);
  const K_PULL_TO_NORMAL = BASE_K_PULL_TO_NORMAL * Math.pow(speedFactor, 2);

  const prevSupply = supply;
  supply += GRADUAL_SUPPLY_SPEED * (demand - supply);
  supply = Math.max(1, supply);

  const delta = supply - prevSupply;
  const deltaNorm = delta / Math.max(1, demand);
  const diff = (supply - demand) / Math.max(1, demand);

  let force = -K_SUPPLY_DEVIATION * diff;
  force += -K_DELTA_SUPPLY * deltaNorm;
  force += K_PULL_TO_NORMAL * (avgProfitRate - marketProfitRate);

  marketProfitRate += force;

  const damping = 0.98 + (1 - speedFactor) * 0.015;
  marketProfitRate = marketProfitRate * damping + (1 - damping) * avgProfitRate;

  marketProfitRate = Math.max(0.0001, marketProfitRate);
  marketProfitRate = Math.min(2.0, marketProfitRate);

  document.getElementById('marketProfitRate').value = (marketProfitRate*100).toFixed(0);
  document.getElementById('supply').value = supply.toFixed(2);

  const nP = naturalPrice(cost, avgProfitRate);
  const mP = marketPrice(cost, marketProfitRate);

  document.getElementById('naturalPrice').textContent = nP.toFixed(2);
  document.getElementById('marketPrice').textContent = mP.toFixed(2);
  syncDisplays();

  chart.data.datasets[0].data = [{ x:demand, y:0 }, { x:demand, y:mP*3 }];
  chart.data.datasets[1].data = Array(501).fill(nP);
  chart.data.datasets[2].data = [{ x: supply, y: mP }];
  chart.data.datasets[3].data = [{ x:supply, y:0 }, { x:supply, y:mP*3 }];

  chart.options.scales.y.min = 0;
  chart.options.scales.y.max = Math.max(nP, mP) * 1.2;

  chart.update();
  requestAnimationFrame(update);
}

requestAnimationFrame(update);

document.getElementById('speedControl').addEventListener('input', e=>{
  speedFactor = parseFloat(e.target.value);
  syncDisplays();
});
document.getElementById('avgProfitRate').addEventListener('input', syncDisplays);
document.getElementById('demand').addEventListener('input', syncDisplays);
document.getElementById('marketProfitRate').addEventListener('input', syncDisplays);
</script>

<script>
  // fundo animado - partículas conectadas (Copiado de pasted_content_2.txt)
  const canvas = document.getElementById('particles');
  const ctxParticles = canvas.getContext('2d');
  let particlesArray = [];
  const numParticles = 80;

  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  class Particle {
    constructor() {
      this.x = Math.random() * canvas.width;
      this.y = Math.random() * canvas.height;
      this.size = Math.random() * 2;
      this.speedX = (Math.random() - 0.5) * 0.8;
      this.speedY = (Math.random() - 0.5) * 0.8;
    }
    update() {
      this.x += this.speedX;
      this.y += this.speedY;
      if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
      if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
    }
    draw() {
      ctxParticles.fillStyle = '#38bdf8';
      ctxParticles.beginPath();
      ctxParticles.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      ctxParticles.fill();
    }
  }

  function connect() {
    for (let a = 0; a < particlesArray.length; a++) {
      for (let b = a; b < particlesArray.length; b++) {
        let dx = particlesArray[a].x - particlesArray[b].x;
        let dy = particlesArray[a].y - particlesArray[b].y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < 100) {
          ctxParticles.strokeStyle = 'rgba(56,189,248,0.1)';
          ctxParticles.lineWidth = 1;
          ctxParticles.beginPath();
          ctxParticles.moveTo(particlesArray[a].x, particlesArray[a].y);
          ctxParticles.lineTo(particlesArray[b].x, particlesArray[b].y);
          ctxParticles.stroke();
        }
      }
    }
  }

  function initParticles() {
    particlesArray = [];
    for (let i = 0; i < numParticles; i++) {
      particlesArray.push(new Particle());
    }
  }

  function animateParticles() {
    ctxParticles.clearRect(0, 0, canvas.width, canvas.height);
    for (let particle of particlesArray) {
      particle.update();
      particle.draw();
    }
    connect();
    requestAnimationFrame(animateParticles);
  }

  window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    initParticles();
  });

  initParticles();
  animateParticles();
</script>

</body>
</html>
